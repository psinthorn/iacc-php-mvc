# =============================================================================
# iACC - Staging/Development Deployment Workflow
# =============================================================================
# Triggered on push to develop branch
# Deploys to: dev.iacc.f2.co.th (staging) or staging folder
# =============================================================================

name: üß™ Deploy to Staging

on:
  push:
    branches:
      - develop
  workflow_dispatch:  # Allow manual trigger

env:
  DEPLOY_PATH: dev.iacc.f2.co.th  # cPanel folder for staging subdomain

jobs:
  # =========================================================================
  # Job 1: Build and Test
  # =========================================================================
  build:
    name: üî® Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        
      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mysqli, mbstring, xml, gd, curl
          
      - name: ‚úÖ PHP Syntax Check
        timeout-minutes: 2
        run: |
          echo "Checking main PHP files..."
          php -l index.php
          php -l core-function.php
          php -l login.php
          php -l inc/class.dbconn.php
          php -l inc/security.php
          echo "‚úÖ Syntax check passed"
          
      - name: üì¶ Create deployment artifact
        run: |
          mkdir -p deploy
          rsync -av --progress \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.gitignore' \
            --exclude='.DS_Store' \
            --exclude='.venv' \
            --exclude='.env' \
            --exclude='docker' \
            --exclude='docker-compose*.yml' \
            --exclude='Dockerfile' \
            --exclude='*.bak' \
            --exclude='*.backup' \
            --exclude='build' \
            --exclude='node_modules' \
            --exclude='TODAY_WORK_SUMMARY*.txt' \
            --exclude='phpstan.neon' \
            --exclude='deploy-cpanel.sh' \
            --exclude='inc/sys.configs.php' \
            --exclude='inc/docker-settings.json' \
            --exclude='logs/*.log' \
            --exclude='cache/*' \
            --exclude='backups/*' \
            ./ deploy/
            
      - name: üì§ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: staging-deploy
          path: deploy/
          retention-days: 3

  # =========================================================================
  # Job 2: Deploy to Staging
  # =========================================================================
  deploy:
    name: üß™ Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: staging
      url: https://dev.iacc.f2.co.th
    
    steps:
      - name: üì• Download artifact
        uses: actions/download-artifact@v4
        with:
          name: staging-deploy
          path: deploy/
          
      - name: üîß Prepare staging config
        run: |
          # Use staging config (same as cpanel but with staging DB)
          if [ -f deploy/inc/sys.configs.cpanel.php ]; then
            cp deploy/inc/sys.configs.cpanel.php deploy/inc/sys.configs.php
            # Note: You'll need to update the config with staging DB credentials
            # This is done via GitHub secrets or a staging-specific config file
          fi
          # Use production htaccess (security settings same for staging)
          if [ -f deploy/.htaccess.cpanel ]; then
            cp deploy/.htaccess.cpanel deploy/.htaccess
          fi
          
      - name: üì§ Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        timeout-minutes: 10
        with:
          # server: ${{ secrets.FTP_SERVER }}
          server: ftp.f2.co.th
          username: ${{ secrets.FTP_USERNAME_STAGING }}
          password: ${{ secrets.FTP_PASSWORD_STAGING }}
          # port: ${{ secrets.FTP_PORT || 21 }}
          protocol: ftp
          local-dir: ./deploy/
          server-dir: ${{ env.DEPLOY_PATH }}/
          timeout: 60000
          log-level: verbose
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.env
            **/logs/*.log
            **/cache/*
            **/backups/*
            
      - name: ‚úÖ Deployment notification
        run: |
          echo "‚úÖ Staging deployment completed!"
          echo "üåê URL: https://dev.iacc.f2.co.th"
          echo "üìÖ Time: $(date)"
          echo "üîñ Commit: ${{ github.sha }}"
          echo ""
          echo "üìã Next steps:"
          echo "   1. Test the staging environment"
          echo "   2. If all tests pass, create PR to main"
          echo "   3. Merge to main for production deployment"

  # =========================================================================
  # Job 3: Post-Deploy Notification
  # =========================================================================
  notify:
    name: üì¢ Notify Team
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: üìß Send notification
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "‚úÖ Staging deployment successful!"
          else
            echo "‚ùå Staging deployment failed!"
          fi
          # Add Slack/Discord/Email notification here if needed
