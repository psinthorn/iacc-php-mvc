# =============================================================================
# iACC - Production Deployment Workflow
# =============================================================================
# Triggered on push to main branch
# Deploys to: iacc.f2.co.th (production)
# =============================================================================

name: ðŸš€ Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  DEPLOY_PATH: .  # Deploy to the root of the FTP target directory

jobs:
  # =========================================================================
  # Job 1: Build and Test
  # =========================================================================
  build:
    name: ðŸ”¨ Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mysqli, mbstring, xml, gd, curl
          
      - name: âœ… PHP Syntax Check
        timeout-minutes: 2
        run: |
          echo "Checking main PHP files..."
          php -l index.php
          php -l core-function.php
          php -l login.php
          php -l inc/class.dbconn.php
          php -l inc/security.php
          echo "âœ… Syntax check passed"
          
      - name: ðŸ“¦ Create deployment artifact
        run: |
          mkdir -p deploy
          rsync -av --progress \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.gitignore' \
            --exclude='.DS_Store' \
            --exclude='.venv' \
            --exclude='.env' \
            --exclude='docker' \
            --exclude='docker-compose*.yml' \
            --exclude='Dockerfile' \
            --exclude='*.bak' \
            --exclude='*.backup' \
            --exclude='build' \
            --exclude='node_modules' \
            --exclude='TODAY_WORK_SUMMARY*.txt' \
            --exclude='phpstan.neon' \
            --exclude='deploy-cpanel.sh' \
            --exclude='inc/sys.configs.php' \
            --exclude='inc/docker-settings.json' \
            --exclude='logs/*.log' \
            --exclude='cache/*' \
            --exclude='backups/*' \
            ./ deploy/
            
      - name: ðŸ“¤ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: production-deploy
          path: deploy/
          retention-days: 5

  # =========================================================================
  # Job 2: Deploy to Production
  # =========================================================================
  deploy:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
      url: https://iacc.f2.co.th
    
    steps:
      - name: ðŸ“¥ Download artifact
        uses: actions/download-artifact@v4
        with:
          name: production-deploy
          path: deploy/
          
      - name: ðŸ› ï¸ Generate production config from secrets
        run: |
          mkdir -p deploy/inc
          cat > deploy/inc/sys.configs.php <<EOL
          <?php
          $config["username"] = "${{ secrets.DB_USERNAME }}";
          $config["password"] = "${{ secrets.DB_PASSWORD }}";
          $config["dbname"]   = "${{ secrets.DB_NAME }}";
          $config["host"]     = "${{ secrets.DB_HOST }}";
          EOL
          # Use production htaccess
          if [ -f deploy/.htaccess.cpanel ]; then
            cp deploy/.htaccess.cpanel deploy/.htaccess
          fi
          # Ensure all config templates and .htaccess.cpanel are deployed
          for f in deploy/inc/sys.configs.*.php; do
            [ -e "$f" ] && cp "$f" deploy/inc/ || true
          done
          if [ -f deploy/.htaccess.cpanel ]; then
            cp deploy/.htaccess.cpanel deploy/
          fi
          
      - name: ðŸ“¤ Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        timeout-minutes: 10
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || 21 }}
          protocol: ftp
          local-dir: ./deploy/
          server-dir: ${{ env.DEPLOY_PATH }}/
          timeout: 60000
          log-level: verbose
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.env
            **/logs/*.log
            **/cache/*
            **/backups/*
            
      - name: âœ… Deployment notification
        run: |
          echo "âœ… Production deployment completed!"
          echo "ðŸŒ URL: https://iacc.f2.co.th"
          echo "ðŸ“… Time: $(date)"
          echo "ðŸ”– Commit: ${{ github.sha }}"

  # =========================================================================
  # Job 3: Post-Deploy Health Check
  # =========================================================================
  health-check:
    name: ðŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: ðŸ” Check site availability
        run: |
          echo "Waiting for deployment to propagate..."
          sleep 30
          
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://iacc.f2.co.th || echo "000")
          
          if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "302" ]; then
            echo "âœ… Site is up! HTTP Status: $HTTP_STATUS"
          else
            echo "âš ï¸ Site may have issues. HTTP Status: $HTTP_STATUS"
            # Don't fail the workflow, just warn
          fi
